<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iSensor-SPI-Buffer: iSensor SPI Buffer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Analog-Devices-Logo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iSensor-SPI-Buffer
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Firmware for the STM32F303 to enable full throughput buffered data capture on Analog Devices IMUs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">iSensor SPI Buffer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The iSensor SPI Buffer is a hardware and software solution designed to buffer iSensor IMU data, enabling asynchronous sampling systems (specifically embedded Linux systems) such as the Raspberry Pi, BeagleBone, Nvidia Jetson, etc. to capture IMU data at high sampling rates <b>with accurate timestamps and</b> <b>without data loss</b>.</p>
<p>The firmware is architected around an STM32F303 to enable full-throughput, buffered data captures as well as an ADG1611 analog switch IC to enable routing SYNC and DATA READY signals from a host processor directly to the IMU. The SPI buffer board is designed to be compatible with all current and future iSensor IMU products.</p>
<p>A custom PCB was designed to fit the profile and form factor of an ADIS1649x IMU. This profile allows the iSensor SPI Buffer to act as a drop-in solution for existing, high-performance solutions. The buffer interface is designed to mimic the iSensor page convention and SPI settings out-of-the box.</p>
<p>Additional hardware and software resources are linked below.</p>
<p>Detailed Register Map</p>
<p><a class="el" href="md__c_1__users_anolan3__documents_i_sensor-_s_p_i-_buffer__u_s_b__c_l_i.html">USB CLI Definition</a></p>
<p><a class="el" href="md__c_1__users_anolan3__documents_i_sensor-_s_p_i-_buffer__p_i_n__m_a_p.html">STM32 Processor Pin Map</a></p>
<p><a href="https://ajn96.github.io/iSensor-SPI-Buffer/files.html">Firmware Documentation (Doxygen)</a></p>
<h1>Hardware Platform</h1>
<p>This firmware is designed to operate in the STMicro processor family - specifically the STM32F303 processor. The STM32F303RET6 variant of the processor family was chosen for this application because of its large SRAM and low cost.</p>
<p><img src="https://raw.githubusercontent.com/ajn96/iSensor-SPI-Buffer/master/img/top_image.jpg" alt="iSensor SPI Buffer Top Image" class="inline"/></p>
<p><img src="https://raw.githubusercontent.com/ajn96/iSensor-SPI-Buffer/master/img/back_iso_image.jpg" alt="iSensor SPI Buffer Isometric Image" class="inline"/></p>
<p>Revision B of the PCB design includes the following features:</p>
<ul>
<li>STM32F303RET6 processor (64k SRAM, hardware SPI peripherals, DMA fabric)</li>
<li>ADG1611 analog switch - used for mapping SYNC and DATA READY signals from the IMU to the buffer board or SPI host</li>
<li>ADP1706 high-transient linear regulator - used to regulate USB 5V and power both the IMU and buffer board<ul>
<li>Power supply selection jumper for powering the buffer board &amp; IMU from the 24-pin IMU connector or USB</li>
</ul>
</li>
<li>USB C expansion port - currently unused, but will eventually be used for pushing inertial data to a PC</li>
<li>SD card slot - currently unused, but will enable IMU data to be captured without the use of a PC or SPI host</li>
<li>LEDs - used to indicate buffer state and SPI buffer errors</li>
<li>24-pin IMU connectors - used to interface with and pass through IMU and SPI Buffer data to and from a host using SPI</li>
<li>ADIS1650x footprint - used to enable the evaluation and use of compact iSensor IMUs</li>
</ul>
<p>The iSensor SPI Buffer was designed to sit between an iSensor IMU and the SPI host without changing any existing PCB designs.</p>
<p><b>Note:</b> A <a href="https://www.tag-connect.com/product/tc2030-idc-6-pin-tag-connect-plug-of-nails-spring-pin-cable-with-legs">TC2030-IDC cable</a> must be used to interface with the SWD pads on the Rev B PCB.</p>
<p><img src="https://raw.githubusercontent.com/ajn96/iSensor-SPI-Buffer/master/img/mounted_image.jpg" alt="iSensor SPI Buffer Mounted Image" class="inline"/></p>
<h1>Development Environment</h1>
<p>The code contained in this repository was developed using the freely available <a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide">STM32 Cube IDE</a>.</p>
<h1>Design Requirements and Features</h1>
<h2>IMU Register Interface</h2>
<ul>
<li>"Invisible" SPI pass-through to an iSensor IMU, including modules that implement register pages</li>
<li>iSensor-SPI-Buffer configuration registers and buffered data acquisition registers will be placed on unassigned IMU pages (Pages 253 - 255)</li>
</ul>
<h2>Buffered Data Acquisition</h2>
<ul>
<li>Autonomous IMU data acquisition will be driven by the IMU-generated data ready signal. Data will be stored in the iSensor-SPI-Buffer SRAM until retrieved by a user</li>
<li>Programmable data request message (MOSI) to be transmitted after each data ready signal. Allows users to customize the register writes, contents, and order</li>
<li>Programmable data acquisition length after each IMU data ready signal. Allows the user to configure the length of data read back from the IMU</li>
<li>Programmable data acquisition SPI word size. The default 16-bit length provides support standard register reads, writes, and burst reads on most IMUs</li>
</ul>
<h2>Configuration Options</h2>
<ul>
<li>Buffer overflow setting (stop sampling vs delete oldest)</li>
<li>Data ready input (from IMU) DIO number</li>
<li>IMU Data ready trigger polarity</li>
<li>Master SPI (interface between the iSensor-SPI-Buffer firmware and the IMU)<ul>
<li>SCLK Frequency</li>
<li>Stall time</li>
</ul>
</li>
<li>Slave SPI (interface between the iSensor-SPI-Buffer firmware and the host processor)<ul>
<li>Standard SPI settings (CPOL, CPHA, endianness)</li>
</ul>
</li>
</ul>
<h2>Buffer Design</h2>
<ul>
<li>Reading a buffer retrieve register will dequeue data from the buffer data strcture to the buffer output registers for retrieval by a user</li>
<li>The user will can clear the buffer using a control register</li>
<li>A buffer counter will be added to each buffer for the user to keep track of the state of the buffer. This counter must also be accessible without dequeuing data from buffer</li>
<li>Using a maximum buffer entry size of 64 bytes, the buffer will provide a minimum of 512 frames of buffering using 32KB SRAM<ul>
<li>STM32F303 has 80KB of SRAM available, so more than 512 entries may be feasible</li>
</ul>
</li>
</ul>
<h1>Architecture</h1>
<h2>SPI Ports</h2>
<p>The iSensor-SPI-Buffer firmware will utilize two hardware SPI ports. One operating as a master (SPI buffer to IMU communication) and the other as a slave (SPI buffer to host)</p><ul>
<li>The slave SPI port will expose the IMU register interface along with the iSensor-SPI-Buffer configuration registers to the master</li>
<li>The slave SPI port will support all standard SPI configuration parameters</li>
<li>The master SPI port will communicate with the IMU using the standard, iSensor SPI protocol</li>
<li>The master SPI port configuration will be limited to customizing SCLK frequency and stall time</li>
</ul>
<h2>Program Flow</h2>
<p>The iSensor-SPI-Buffer communications handling will be interrupt-driven to remove as much influence from the ST processor as possible. A main cyclic executive loop handles command execution, interrupt generation, and diagnostics.</p>
<p><b>User SPI Interrupt</b></p>
<p>There will be an ISR to handle user-initiated SPI transactions (slave interface). If the active register page is not one of the SPI buffer pages (253 - 255) all SPI transactions will be forwarded to the IMU downstream.</p>
<p>SPI transactions will be classified as "read" or "write" by the SPI buffer board the same as the iSensor IMU SPI protocol. A write operation is signaled by setting the MSB of each 16-bit word. The upper 8 bits of the 16-bit transaction contain the register address to be written to as well as the read/write bit. The lower 8 bits of the 16-bit transaction contain the data to be written.</p>
<p>A single read request transmitted to the SPI buffer on the slave interface will result in <em>two</em> SPI transactions sent to the IMU on the master interface. The first transaction sends the register read request to the IMU and the second reads the requested register contents data back from the IMU. The requested IMU register is then loaded into the SPI buffer user SPI transmit buffer so that it is available to the user on the next user SPI transaction. For write transactions, a single write command will be sent to the IMU. The data resulting from the write transaction is then loaded into the SPI buffer user SPI transmit buffer. Unlike the read operation, a write operation will not automatically generate an additional SPI transaction.</p>
<p><b>Autonomous Data Capture</b></p>
<p>When the currently selected page is 255 (buffer output register page), the iSensor SPI Buffer firmware will begin to monitor a user-specified GPIO interrupt for data ready signals pulses. Once a data ready pulse is detected, the firmware will transmit the data contained in page 254 (buffer transmit data) in the order specified by the user. Data received from the IMU during each 16-bit transaction will be stored in a new buffer entry in the iSensor-SPI-Buffer SRAM. The firmware will use DMA and timer peripherals to perform the SPI transactions with minimal CPU intervention while giving control over the SPI SCLK and stall time.</p>
<p>The data capture ISR will be triggered by a user-specified GPIO, corresponding to the IMU data ready signal. The data capture ISR will configure a timer peripheral (which drives SPI word transmission timing) to trigger a DMA between memory and SPI. A DMA done ISR will handle cleaning up the DMA transactions and incrementing buffer pointers following a complete data set acquisition from the IMU. If the selected page is changed off page 255, the IMU data ready interrupt data capture functionality will be disabled (can be re-enabled by writing 255 to the page ID register on any page).</p>
<p><img src="https://raw.githubusercontent.com/ajn96/iSensor-SPI-Buffer/master/img/Data_Capture_Flow.jpg" alt="Buffered Capture Data Flow" class="inline"/></p>
<p><b>User Interrupt Signaling (to host)</b></p>
<p>Each of the four DIO lines from the iSensor-SPI-Buffer to the master device can be configured to operate in one of four modes</p><ul>
<li>Watermark Interrupt Mode: The selected DIO will go high when a specified number of samples are available to be dequeued. This allows a master device to simply monitor the data ready interrupt signal for a positive edge, and then dequeue a large number of IMU data samples</li>
<li>Buffer Full Interrupt Mode: The selected DIO will go high when the buffer is full</li>
<li>Error Interrupt Mode: The selected DIO will go high when an error is detected and flagged in the STATUS register</li>
<li>Pin Pass-Through Mode: The DIO output from the IMU (e.g. a data ready signal or sync signal) will be directly connected to the master device, using an ADG1611 switch. When a DIO is configured in pin pass-through mode it cannot be used for interrupt signalling</li>
</ul>
<p>The state of each interrupt signal is checked and updated on each iteration of the main cyclic executive loop. This ensures quick response time to changes in the buffer state while maintaining a simple program flow.</p>
<p><b>Command Execution</b></p>
<ul>
<li>When a write is issued the USER_COMMAND register, a COMMAND flag will be set and processed by the cyclic executive loop</li>
<li>While a command is being executed, the user SPI port will be disabled, and any interrupt lines (data ready or buffer full) will be brought low</li>
</ul>
<h2>Register Interface</h2>
<ul>
<li>Configuration registers for iSensor SPI buffer will be available on page 253</li>
<li>The data acquisition write data registers (data to transmit per data ready) will be on page 254</li>
<li>Buffer output data registers will be on page 255 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
