<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iSensor-SPI-Buffer: C:/Users/anolan3/Documents/iSensor-SPI-Buffer/Core/Src/adc.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Analog-Devices-Logo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iSensor-SPI-Buffer
   &#160;<span id="projectnumber">1.10</span>
   </div>
   <div id="projectbrief">Firmware for the STM32F303 to enable full throughput buffered data capture on Analog Devices IMUs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_c6310732a22f63c0c2fc5595561e68f1.html">Core</a></li><li class="navelem"><a class="el" href="dir_b596f468b52957496e4f78b80e029268.html">Src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">adc.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Implementation file for iSensor-SPI-Buffer ADC module (for temp sensor and Vdd monitoring)  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="adc_8h_source.html">adc.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a55995e9dd1e94588c71e49f40dc2dd61"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#a55995e9dd1e94588c71e49f40dc2dd61">ProcessTempReading</a> ()</td></tr>
<tr class="memdesc:a55995e9dd1e94588c71e49f40dc2dd61"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handle end of conversion for a temp sensor value.  <a href="adc_8c.html#a55995e9dd1e94588c71e49f40dc2dd61">More...</a><br /></td></tr>
<tr class="separator:a55995e9dd1e94588c71e49f40dc2dd61"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a57cb7226dfb1ff1a7329f1ac9d4f512d"><td class="memItemLeft" align="right" valign="top">static int16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#a57cb7226dfb1ff1a7329f1ac9d4f512d">ScaleTempData</a> (uint32_t rawTemp)</td></tr>
<tr class="memdesc:a57cb7226dfb1ff1a7329f1ac9d4f512d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Scale raw ADC temperature data to temp output.  <a href="adc_8c.html#a57cb7226dfb1ff1a7329f1ac9d4f512d">More...</a><br /></td></tr>
<tr class="separator:a57cb7226dfb1ff1a7329f1ac9d4f512d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c7436c8ad95d28579575f233c6b3010"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#a7c7436c8ad95d28579575f233c6b3010">GetVdd</a> (uint32_t VrefMeasurement)</td></tr>
<tr class="memdesc:a7c7436c8ad95d28579575f233c6b3010"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate Vdd from VREFINT measurement.  <a href="adc_8c.html#a7c7436c8ad95d28579575f233c6b3010">More...</a><br /></td></tr>
<tr class="separator:a7c7436c8ad95d28579575f233c6b3010"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb6cb5368cffd96c7e2cce8c72744ea2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#adb6cb5368cffd96c7e2cce8c72744ea2">ADCInit</a> ()</td></tr>
<tr class="memdesc:adb6cb5368cffd96c7e2cce8c72744ea2"><td class="mdescLeft">&#160;</td><td class="mdescRight">ADC1 Initialization Function.  <a href="adc_8c.html#adb6cb5368cffd96c7e2cce8c72744ea2">More...</a><br /></td></tr>
<tr class="separator:adb6cb5368cffd96c7e2cce8c72744ea2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a88d8b1c45444aeddd983d3add5e8224e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#a88d8b1c45444aeddd983d3add5e8224e">UpdateADC</a> ()</td></tr>
<tr class="memdesc:a88d8b1c45444aeddd983d3add5e8224e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read and scale ADC values then load to output registers.  <a href="adc_8c.html#a88d8b1c45444aeddd983d3add5e8224e">More...</a><br /></td></tr>
<tr class="separator:a88d8b1c45444aeddd983d3add5e8224e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a22b804736f5648d52f639b2647d4ed13"><td class="memItemLeft" align="right" valign="top">static ADC_HandleTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#a22b804736f5648d52f639b2647d4ed13">hadc1</a></td></tr>
<tr class="separator:a22b804736f5648d52f639b2647d4ed13"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a498acc08ff841f6655df28c1681f954f"><td class="memItemLeft" align="right" valign="top">volatile uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8c.html#a498acc08ff841f6655df28c1681f954f">g_regs</a> []</td></tr>
<tr class="separator:a498acc08ff841f6655df28c1681f954f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation file for iSensor-SPI-Buffer ADC module (for temp sensor and Vdd monitoring) </p>
<p>Copyright (c) Analog Devices Inc, 2020 All Rights Reserved.</p>
<dl class="section date"><dt>Date</dt><dd>7/10/2020 </dd></dl>
<dl class="section author"><dt>Author</dt><dd>A. Nolan (<a href="#" onclick="location.href='mai'+'lto:'+'ale'+'x.'+'nol'+'an'+'@an'+'al'+'og.'+'co'+'m'; return false;">alex.<span style="display: none;">.nosp@m.</span>nola<span style="display: none;">.nosp@m.</span>n@ana<span style="display: none;">.nosp@m.</span>log.<span style="display: none;">.nosp@m.</span>com</a>) </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="adb6cb5368cffd96c7e2cce8c72744ea2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb6cb5368cffd96c7e2cce8c72744ea2">&#9670;&nbsp;</a></span>ADCInit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADCInit </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>ADC1 Initialization Function. </p>
<dl class="section return"><dt>Returns</dt><dd>None</dd></dl>
<p>This function should be called once as part of the firmware initialization process.</p>
<p>Initializes ADC1 in single sampling mode, with two input channels converted (temp sensor and VREFINT). The sample time is set to 601 ADC cycles. The ADC is clocked from 72MHz core clock divided by 8. 601 cycles / (72MHz/8) -&gt; 66us. The Temp sensor requires a minimum 10us setting time for accurate measurements. Because these values are measured for diagnostics monitoring pursposes only, using a long sample time is not a problem. </p>

</div>
</div>
<a id="a7c7436c8ad95d28579575f233c6b3010"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7c7436c8ad95d28579575f233c6b3010">&#9670;&nbsp;</a></span>GetVdd()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint16_t GetVdd </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>VrefMeasurement</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculate Vdd from VREFINT measurement. </p>
<dl class="section return"><dt>Returns</dt><dd>Vdd voltage (1V = 100LSBs)</dd></dl>
<p>VREFINT as a regulated ~1.23V supply generated by the STM32 processor core internally. The value of VREFINT with Vdd = 3.3V is logged by ST during production (stored in VREFINT_CAL). Theoretical value of 1501</p>
<p>In general, when an ADC measurement is performed, the ADC output = (2^12 - 1) * voltage / Vdd</p>
<p>so Vref (real voltage) = VREFINT_CAL * 3.3 / (2^12 - 1)</p>
<p>Therefore a measurement of the current Vref is equivalent to:</p>
<p>VrefMeasurement = (2^12 - 1) * (VREFINT_CAL * 3.3 / (2^12 - 1)) / Vdd VrefMeasurement = VREFINT_CAL * 3.3 / Vdd Vdd = VREFINT_CAL * 3.3 / VrefMeasurement </p>

</div>
</div>
<a id="a55995e9dd1e94588c71e49f40dc2dd61"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55995e9dd1e94588c71e49f40dc2dd61">&#9670;&nbsp;</a></span>ProcessTempReading()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void ProcessTempReading </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Handle end of conversion for a temp sensor value. </p>
<p>This function reads the latest temp sensor output value and applies it to the temp sensor decimation averaging filter. If the end of a decimation period has been reached, it updates the temperature sensor output value and flags any temperature over range events in the STATUS register (outside -40C to 85C). </p>

</div>
</div>
<a id="a57cb7226dfb1ff1a7329f1ac9d4f512d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a57cb7226dfb1ff1a7329f1ac9d4f512d">&#9670;&nbsp;</a></span>ScaleTempData()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int16_t ScaleTempData </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>rawTemp</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Scale raw ADC temperature data to temp output. </p>
<dl class="section return"><dt>Returns</dt><dd>temp value (10LSB = 1C)</dd></dl>
<p>Temp (in C, 10LSB per degree) = (800 / (TS_CAL2 - TS_CAL1)) * (val - TS_CAL1) + 300</p>
<p>The CAL values are measured with VREF = 3.3V at the factory. To make the measurement accurate, the most recent value read for VDD (using ADC VREFINT measurement) is used to normalize the raw temperature sensor measurement to a 3.3V reference voltage. </p>

</div>
</div>
<a id="a88d8b1c45444aeddd983d3add5e8224e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a88d8b1c45444aeddd983d3add5e8224e">&#9670;&nbsp;</a></span>UpdateADC()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void UpdateADC </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read and scale ADC values then load to output registers. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function drives the ADC state machine and should be called periodically from the cyclic executive. The ADC is configured in non-continuous scanning mode, with the temp sensor and VREFINT channels enabled. For each channel, the state machine initiates an ADC sample, then goes to a wait state which does not advance until the EOC flag for that sample has been set. The VREFINT channel is sampled prior to the temp sensor channel, because the calculated Vdd value is used to compensate the temp sensor scale factor. </p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a498acc08ff841f6655df28c1681f954f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a498acc08ff841f6655df28c1681f954f">&#9670;&nbsp;</a></span>g_regs</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint16_t g_regs[]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Global register array. (from <a class="el" href="registers_8c.html" title="iSensor-SPI-Buffer register interfacing module. Called by user SPI and USB CLI">registers.c</a>) </p>

</div>
</div>
<a id="a22b804736f5648d52f639b2647d4ed13"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22b804736f5648d52f639b2647d4ed13">&#9670;&nbsp;</a></span>hadc1</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">ADC_HandleTypeDef hadc1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>HAL ADC handle </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
