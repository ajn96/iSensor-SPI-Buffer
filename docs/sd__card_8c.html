<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iSensor-SPI-Buffer: C:/Users/anolan3/Documents/iSensor-SPI-Buffer/Core/Src/sd_card.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Analog-Devices-Logo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iSensor-SPI-Buffer
   &#160;<span id="projectnumber">1.10</span>
   </div>
   <div id="projectbrief">Firmware for the STM32F303 to enable full throughput buffered data capture on Analog Devices IMUs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_c6310732a22f63c0c2fc5595561e68f1.html">Core</a></li><li class="navelem"><a class="el" href="dir_b596f468b52957496e4f78b80e029268.html">Src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">sd_card.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>iSensor-SPI-Buffer SD card interfacing and script execution module  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="sd__card_8h_source.html">sd_card.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a686e0e25c004ba96a80b7f9eccb65f95"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a686e0e25c004ba96a80b7f9eccb65f95">OpenScriptFiles</a> ()</td></tr>
<tr class="memdesc:a686e0e25c004ba96a80b7f9eccb65f95"><td class="mdescLeft">&#160;</td><td class="mdescRight">Mount SD card an open "script.txt" and "result.txt".  <a href="sd__card_8c.html#a686e0e25c004ba96a80b7f9eccb65f95">More...</a><br /></td></tr>
<tr class="separator:a686e0e25c004ba96a80b7f9eccb65f95"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a091d146cc644caa26078156892f38997"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a091d146cc644caa26078156892f38997">SDCardAttached</a> ()</td></tr>
<tr class="memdesc:a091d146cc644caa26078156892f38997"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check if SD card is attached.  <a href="sd__card_8c.html#a091d146cc644caa26078156892f38997">More...</a><br /></td></tr>
<tr class="separator:a091d146cc644caa26078156892f38997"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1689ac486229c2f0a44ee3e69090f3ff"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a1689ac486229c2f0a44ee3e69090f3ff">ParseScriptFile</a> ()</td></tr>
<tr class="memdesc:a1689ac486229c2f0a44ee3e69090f3ff"><td class="mdescLeft">&#160;</td><td class="mdescRight">Parse script.txt into script element array (cmdList)  <a href="sd__card_8c.html#a1689ac486229c2f0a44ee3e69090f3ff">More...</a><br /></td></tr>
<tr class="separator:a1689ac486229c2f0a44ee3e69090f3ff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a98569f945d958c0809e96005cdb2d3a7"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a98569f945d958c0809e96005cdb2d3a7">CommandPostLoadProcess</a> ()</td></tr>
<tr class="memdesc:a98569f945d958c0809e96005cdb2d3a7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Process loaded command array.  <a href="sd__card_8c.html#a98569f945d958c0809e96005cdb2d3a7">More...</a><br /></td></tr>
<tr class="separator:a98569f945d958c0809e96005cdb2d3a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa982ad2254de265717f1ad2404cf53ad"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#aa982ad2254de265717f1ad2404cf53ad">SPI3_Init</a> (void)</td></tr>
<tr class="memdesc:aa982ad2254de265717f1ad2404cf53ad"><td class="mdescLeft">&#160;</td><td class="mdescRight">SPI3 Initialization Function (SD card master SPI port)  <a href="sd__card_8c.html#aa982ad2254de265717f1ad2404cf53ad">More...</a><br /></td></tr>
<tr class="separator:aa982ad2254de265717f1ad2404cf53ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a85638c35dfe6f3becb0836208a037713"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a85638c35dfe6f3becb0836208a037713">ParseReadBuffer</a> (UINT bytesRead)</td></tr>
<tr class="memdesc:a85638c35dfe6f3becb0836208a037713"><td class="mdescLeft">&#160;</td><td class="mdescRight">Parse a script buffer read from the SD card.  <a href="sd__card_8c.html#a85638c35dfe6f3becb0836208a037713">More...</a><br /></td></tr>
<tr class="separator:a85638c35dfe6f3becb0836208a037713"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d1f2d063a0389e1db1e31b7cc174a89"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a3d1f2d063a0389e1db1e31b7cc174a89">SDTxHandler</a> (const uint8_t *buf, uint32_t count)</td></tr>
<tr class="memdesc:a3d1f2d063a0389e1db1e31b7cc174a89"><td class="mdescLeft">&#160;</td><td class="mdescRight">SD card write handler function.  <a href="sd__card_8c.html#a3d1f2d063a0389e1db1e31b7cc174a89">More...</a><br /></td></tr>
<tr class="separator:a3d1f2d063a0389e1db1e31b7cc174a89"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a625b0dce0e53a68e74b117c8ced97afe"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a625b0dce0e53a68e74b117c8ced97afe">SDCardInit</a> ()</td></tr>
<tr class="memdesc:a625b0dce0e53a68e74b117c8ced97afe"><td class="mdescLeft">&#160;</td><td class="mdescRight">Init SD card hardware interface and FATFs driver.  <a href="sd__card_8c.html#a625b0dce0e53a68e74b117c8ced97afe">More...</a><br /></td></tr>
<tr class="separator:a625b0dce0e53a68e74b117c8ced97afe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ade0e1d4a61790fd47ec542cbf559af68"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#ade0e1d4a61790fd47ec542cbf559af68">ScriptAutorun</a> ()</td></tr>
<tr class="memdesc:ade0e1d4a61790fd47ec542cbf559af68"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run SD card script automatic execution process.  <a href="sd__card_8c.html#ade0e1d4a61790fd47ec542cbf559af68">More...</a><br /></td></tr>
<tr class="separator:ade0e1d4a61790fd47ec542cbf559af68"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3549a7ed2c1d2569224b55e2d286c0e8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a3549a7ed2c1d2569224b55e2d286c0e8">StartScript</a> ()</td></tr>
<tr class="memdesc:a3549a7ed2c1d2569224b55e2d286c0e8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Start script run.  <a href="sd__card_8c.html#a3549a7ed2c1d2569224b55e2d286c0e8">More...</a><br /></td></tr>
<tr class="separator:a3549a7ed2c1d2569224b55e2d286c0e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad6088aedec2b1022a826a94f45805854"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#ad6088aedec2b1022a826a94f45805854">StopScript</a> ()</td></tr>
<tr class="memdesc:ad6088aedec2b1022a826a94f45805854"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stop a running SD card script.  <a href="sd__card_8c.html#ad6088aedec2b1022a826a94f45805854">More...</a><br /></td></tr>
<tr class="separator:ad6088aedec2b1022a826a94f45805854"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32b1dbc0c13c1814f562104c761f8d6c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a32b1dbc0c13c1814f562104c761f8d6c">ScriptStep</a> ()</td></tr>
<tr class="memdesc:a32b1dbc0c13c1814f562104c761f8d6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Step the script execution process.  <a href="sd__card_8c.html#a32b1dbc0c13c1814f562104c761f8d6c">More...</a><br /></td></tr>
<tr class="separator:a32b1dbc0c13c1814f562104c761f8d6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ad9abdec236745828926dbed3d25cfad5"><td class="memItemLeft" align="right" valign="top">volatile uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#ad9abdec236745828926dbed3d25cfad5">g_regs</a> [3 *REG_PER_PAGE]</td></tr>
<tr class="separator:ad9abdec236745828926dbed3d25cfad5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a939ff86f7bddb14b321f51d69a0c683d"><td class="memItemLeft" align="right" valign="top">SPI_HandleTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a939ff86f7bddb14b321f51d69a0c683d">g_spi3</a></td></tr>
<tr class="separator:a939ff86f7bddb14b321f51d69a0c683d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82a90c63ceb17b161d89ae2fe043f8a0"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a82a90c63ceb17b161d89ae2fe043f8a0">sd_buf</a> [<a class="el" href="script_8h.html#ab11983675d40a27dee780f0db1cf1940">STREAM_BUF_SIZE</a>]</td></tr>
<tr class="separator:a82a90c63ceb17b161d89ae2fe043f8a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abac503ce5ea9f04c478a7938a9298277"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structscript.html">script</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#abac503ce5ea9f04c478a7938a9298277">cmdList</a> [<a class="el" href="sd__card_8h.html#a3744cf20327e23a2afb57c9051a55d75">SCRIPT_MAX_ENTRIES</a>]</td></tr>
<tr class="separator:abac503ce5ea9f04c478a7938a9298277"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa910262b7076819c86978d461ecbcd7e"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#aa910262b7076819c86978d461ecbcd7e">cmdIndex</a></td></tr>
<tr class="separator:aa910262b7076819c86978d461ecbcd7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61c98c8516ad997ffdb632f5353d6482"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a61c98c8516ad997ffdb632f5353d6482">numCmds</a></td></tr>
<tr class="separator:a61c98c8516ad997ffdb632f5353d6482"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af2bd5f17cf66c0253d4be43b778a5d1b"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#af2bd5f17cf66c0253d4be43b778a5d1b">scriptRunning</a></td></tr>
<tr class="separator:af2bd5f17cf66c0253d4be43b778a5d1b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac705de537563d408cefd29fdcd813d80"><td class="memItemLeft" align="right" valign="top">static FIL&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#ac705de537563d408cefd29fdcd813d80">cmdFile</a> = {0}</td></tr>
<tr class="separator:ac705de537563d408cefd29fdcd813d80"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9f3ea9e7a9d4ae77e9288e3a97f5409a"><td class="memItemLeft" align="right" valign="top">static FIL&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#a9f3ea9e7a9d4ae77e9288e3a97f5409a">outFile</a> = {0}</td></tr>
<tr class="separator:a9f3ea9e7a9d4ae77e9288e3a97f5409a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae5bcde72e0e0b29ec86d00ba3e5cd51f"><td class="memItemLeft" align="right" valign="top">static FATFS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#ae5bcde72e0e0b29ec86d00ba3e5cd51f">fs</a> = {0}</td></tr>
<tr class="separator:ae5bcde72e0e0b29ec86d00ba3e5cd51f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa54421e5905f4717c763a1943c79b469"><td class="memItemLeft" align="right" valign="top">static const uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sd__card_8c.html#aa54421e5905f4717c763a1943c79b469">ScriptStart</a> [] = &quot;Script Starting...\r\n&quot;</td></tr>
<tr class="separator:aa54421e5905f4717c763a1943c79b469"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>iSensor-SPI-Buffer SD card interfacing and script execution module </p>
<p>Copyright (c) Analog Devices Inc, 2020 All Rights Reserved.</p>
<dl class="section date"><dt>Date</dt><dd>7/28/2020 </dd></dl>
<dl class="section author"><dt>Author</dt><dd>A. Nolan (<a href="#" onclick="location.href='mai'+'lto:'+'ale'+'x.'+'nol'+'an'+'@an'+'al'+'og.'+'co'+'m'; return false;">alex.<span style="display: none;">.nosp@m.</span>nola<span style="display: none;">.nosp@m.</span>n@ana<span style="display: none;">.nosp@m.</span>log.<span style="display: none;">.nosp@m.</span>com</a>) </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a98569f945d958c0809e96005cdb2d3a7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a98569f945d958c0809e96005cdb2d3a7">&#9670;&nbsp;</a></span>CommandPostLoadProcess()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a> CommandPostLoadProcess </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Process loaded command array. </p>
<dl class="section return"><dt>Returns</dt><dd>true if script is good, false otherwise</dd></dl>
<p>This function checks all commands for validity (argument and command). It also sets up all loop state variables, and links the end loop commands to the corresponding start loops. </p>

</div>
</div>
<a id="a686e0e25c004ba96a80b7f9eccb65f95"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a686e0e25c004ba96a80b7f9eccb65f95">&#9670;&nbsp;</a></span>OpenScriptFiles()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a> OpenScriptFiles </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Mount SD card an open "script.txt" and "result.txt". </p>
<dl class="section return"><dt>Returns</dt><dd>true if files are opened successfully, false otherwise</dd></dl>
<p>This function first mounts an attached SD card, then populates the two file handles required for the application. If either file fails to open, both file handles are closed, and the SD card file system is unmounted. </p>

</div>
</div>
<a id="a85638c35dfe6f3becb0836208a037713"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a85638c35dfe6f3becb0836208a037713">&#9670;&nbsp;</a></span>ParseReadBuffer()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void ParseReadBuffer </td>
          <td>(</td>
          <td class="paramtype">UINT&#160;</td>
          <td class="paramname"><em>bytesRead</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Parse a script buffer read from the SD card. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>The script read data to be parsed must be stored in sd_buf. This function iterates through the read array and calls the lower level <a class="el" href="script_8c.html#a3fcce12d9c19ab8120644cb4a2dd72fc" title="Parse a command string into a script element.">ParseScriptElement()</a> routine whenever a newline character is encountered. </p>

</div>
</div>
<a id="a1689ac486229c2f0a44ee3e69090f3ff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1689ac486229c2f0a44ee3e69090f3ff">&#9670;&nbsp;</a></span>ParseScriptFile()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a> ParseScriptFile </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Parse script.txt into script element array (cmdList) </p>
<dl class="section return"><dt>Returns</dt><dd>true if good script, false otherwise</dd></dl>
<p>This function loops through script.txt one read buffer at a time. Each read buffer is then parsed to find the command type and arguments. Any error flags set by ParseScriptElement will cause this function to return false. These flags can be set for invalid commands or arguments. In addition, any error found in command load post-process (which links all control flow related commands) will result in the script being cancelled. </p>

</div>
</div>
<a id="ade0e1d4a61790fd47ec542cbf559af68"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ade0e1d4a61790fd47ec542cbf559af68">&#9670;&nbsp;</a></span>ScriptAutorun()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ScriptAutorun </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run SD card script automatic execution process. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function is intended to be called at the end of the initialization portion of main, just before entering the cyclic executive. If the SD card autorun bit is set in USB_CONFIG and the watchdog reset bit is not set in STATUS, the script will be run. The watchdog reset check is in place to remove the potential for a watchdog reset loop. </p>

</div>
</div>
<a id="a32b1dbc0c13c1814f562104c761f8d6c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a32b1dbc0c13c1814f562104c761f8d6c">&#9670;&nbsp;</a></span>ScriptStep()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ScriptStep </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Step the script execution process. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function is called from the main loop. It is responsible for performing the actual script execution, and writing the output to the SD card (via </p>

</div>
</div>
<a id="a091d146cc644caa26078156892f38997"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a091d146cc644caa26078156892f38997">&#9670;&nbsp;</a></span>SDCardAttached()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a> SDCardAttached </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Check if SD card is attached. </p>
<dl class="section return"><dt>Returns</dt><dd>true if card is attached, false otherwise</dd></dl>
<p>This function makes use of the SD card detect pin to determine if an SD card is inserted without communicating to the SD card directly (floating if no SD card, pulled to ground if there is an SD card). </p>

</div>
</div>
<a id="a625b0dce0e53a68e74b117c8ced97afe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a625b0dce0e53a68e74b117c8ced97afe">&#9670;&nbsp;</a></span>SDCardInit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SDCardInit </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Init SD card hardware interface and FATFs driver. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function configures the SPI3 port for use with an SD card and inits all GPIO as needed. This function is called directly by the application on startup. It does not attempt to connect to the SD card in any way.lked right into tha </p>

</div>
</div>
<a id="a3d1f2d063a0389e1db1e31b7cc174a89"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d1f2d063a0389e1db1e31b7cc174a89">&#9670;&nbsp;</a></span>SDTxHandler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SDTxHandler </td>
          <td>(</td>
          <td class="paramtype">const uint8_t *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>count</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>SD card write handler function. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buf</td><td>Buffer containing data to write</td></tr>
    <tr><td class="paramname">count</td><td>Number of bytes to write</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function is called by the script execution routines, when a script object is executed from a SD card script context. </p>

</div>
</div>
<a id="aa982ad2254de265717f1ad2404cf53ad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa982ad2254de265717f1ad2404cf53ad">&#9670;&nbsp;</a></span>SPI3_Init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void SPI3_Init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>SPI3 Initialization Function (SD card master SPI port) </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>Configures SPI 3 as master SPI port for SD card SPI mode: 0 SCLK Freq: 4.25MHz SPI word size: 8 bits </p>

</div>
</div>
<a id="a3549a7ed2c1d2569224b55e2d286c0e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3549a7ed2c1d2569224b55e2d286c0e8">&#9670;&nbsp;</a></span>StartScript()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void StartScript </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Start script run. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function checks if an SD card is connected, then sets up the FAT file system if there is a card. Once the file system is set up, "script.txt" is read and parsed, if it exists. Once the script has been processed, the script execution state variables are initialized, and the script is kicked off. The actual script execution work occurs in <a class="el" href="sd__card_8c.html#a32b1dbc0c13c1814f562104c761f8d6c" title="Step the script execution process.">ScriptStep()</a>, which is called periodically from the main cyclic executive loop. </p>

</div>
</div>
<a id="ad6088aedec2b1022a826a94f45805854"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad6088aedec2b1022a826a94f45805854">&#9670;&nbsp;</a></span>StopScript()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void StopScript </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stop a running SD card script. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function can be invoked by the user (via the script cancel command), or will run automatically once the script execution process has finished. It clears the script running flags and the script active STATUS register bit. It then closes the output text file and unmounts from the SD card. </p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ac705de537563d408cefd29fdcd813d80"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac705de537563d408cefd29fdcd813d80">&#9670;&nbsp;</a></span>cmdFile</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">FIL cmdFile = {0}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Handle for command file (cmd.txt in top level directory) </p>

</div>
</div>
<a id="aa910262b7076819c86978d461ecbcd7e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa910262b7076819c86978d461ecbcd7e">&#9670;&nbsp;</a></span>cmdIndex</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t cmdIndex</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Track index within the command list currently being executed </p>

</div>
</div>
<a id="abac503ce5ea9f04c478a7938a9298277"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abac503ce5ea9f04c478a7938a9298277">&#9670;&nbsp;</a></span>cmdList</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structscript.html">script</a> cmdList[<a class="el" href="sd__card_8h.html#a3744cf20327e23a2afb57c9051a55d75">SCRIPT_MAX_ENTRIES</a>]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Command list. Loaded from cmd.txt on the SD card </p>

</div>
</div>
<a id="ae5bcde72e0e0b29ec86d00ba3e5cd51f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae5bcde72e0e0b29ec86d00ba3e5cd51f">&#9670;&nbsp;</a></span>fs</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">FATFS fs = {0}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>File system object </p>

</div>
</div>
<a id="ad9abdec236745828926dbed3d25cfad5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9abdec236745828926dbed3d25cfad5">&#9670;&nbsp;</a></span>g_regs</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint16_t g_regs[3 *REG_PER_PAGE]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Global register array (from <a class="el" href="registers_8c.html" title="iSensor-SPI-Buffer register interfacing module. Called by user SPI and USB CLI">registers.c</a>) </p>

</div>
</div>
<a id="a939ff86f7bddb14b321f51d69a0c683d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a939ff86f7bddb14b321f51d69a0c683d">&#9670;&nbsp;</a></span>g_spi3</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SPI_HandleTypeDef g_spi3</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>SPI handle for SD card master port (global scope) </p>

</div>
</div>
<a id="a61c98c8516ad997ffdb632f5353d6482"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a61c98c8516ad997ffdb632f5353d6482">&#9670;&nbsp;</a></span>numCmds</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t numCmds</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Number of commands within the current script </p>

</div>
</div>
<a id="a9f3ea9e7a9d4ae77e9288e3a97f5409a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9f3ea9e7a9d4ae77e9288e3a97f5409a">&#9670;&nbsp;</a></span>outFile</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">FIL outFile = {0}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Handle for output file (result.txt in top level directory) </p>

</div>
</div>
<a id="af2bd5f17cf66c0253d4be43b778a5d1b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af2bd5f17cf66c0253d4be43b778a5d1b">&#9670;&nbsp;</a></span>scriptRunning</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t scriptRunning</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Track if a script is actively running </p>

</div>
</div>
<a id="aa54421e5905f4717c763a1943c79b469"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa54421e5905f4717c763a1943c79b469">&#9670;&nbsp;</a></span>ScriptStart</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const uint8_t ScriptStart[] = &quot;Script Starting...\r\n&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>String literal script start message </p>

</div>
</div>
<a id="a82a90c63ceb17b161d89ae2fe043f8a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82a90c63ceb17b161d89ae2fe043f8a0">&#9670;&nbsp;</a></span>sd_buf</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t sd_buf[<a class="el" href="script_8h.html#ab11983675d40a27dee780f0db1cf1940">STREAM_BUF_SIZE</a>]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Buffer for SD card read/writes </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
