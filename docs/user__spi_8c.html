<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iSensor-SPI-Buffer: user_spi.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Analog-Devices-Logo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iSensor-SPI-Buffer
   &#160;<span id="projectnumber">1.15</span>
   </div>
   <div id="projectbrief">Firmware for the iSensor-SPI-Buffer board to enable full throughput buffered data capture on Analog Devices IMUs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d9edf6c004b4a7ff14fe9ae7a92214ee.html">firmware</a></li><li class="navelem"><a class="el" href="dir_344ad9cf7012f4665e17c8bfb6616899.html">Core</a></li><li class="navelem"><a class="el" href="dir_6fab3234299e4772a3d79f4ae41b7a51.html">Src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">user_spi.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>iSensor-SPI-Buffer user (slave) SPI module  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="reg_8h_source.html">reg.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="user__spi_8h_source.html">user_spi.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="buffer_8h_source.html">buffer.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="isr_8h_source.html">isr.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for user_spi.c:</div>
<div class="dyncontent">
<div class="center"><img src="user__spi_8c__incl.png" border="0" usemap="#auser__spi_8c" alt=""/></div>
<map name="user__spi_8c" id="auser__spi_8c">
<area shape="rect" title="iSensor&#45;SPI&#45;Buffer user (slave) SPI module" alt="" coords="112,5,195,32"/>
<area shape="rect" href="reg_8h.html" title="Header file for iSensor&#45;SPI&#45;Buffer register interfacing module." alt="" coords="165,80,216,107"/>
<area shape="rect" href="user__spi_8h.html" title="Header file for iSensor&#45;SPI&#45;Buffer user SPI (slave SPI) module." alt="" coords="240,80,323,107"/>
<area shape="rect" href="buffer_8h.html" title="Header file for iSensor&#45;SPI&#45;Buffer buffer data structure module." alt="" coords="5,80,69,107"/>
<area shape="rect" href="isr_8h.html" title="Header file for the interrupt service routine module." alt="" coords="94,80,141,107"/>
<area shape="rect" title=" " alt="" coords="121,155,186,181"/>
<area shape="rect" href="main_8h.html" title="Header file for iSensor&#45;SPI&#45;Buffer main." alt="" coords="231,155,292,181"/>
<area shape="rect" title=" " alt="" coords="203,229,320,256"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:af894683d9f035fc8224bdc09e5f911aa"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="user__spi_8c.html#af894683d9f035fc8224bdc09e5f911aa">User_SPI_Reset</a> (<a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a> register_mode)</td></tr>
<tr class="memdesc:af894683d9f035fc8224bdc09e5f911aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reset user SPI port.  <a href="user__spi_8c.html#af894683d9f035fc8224bdc09e5f911aa">More...</a><br /></td></tr>
<tr class="separator:af894683d9f035fc8224bdc09e5f911aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad51e687d5598f38640fb99635774b2bd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="user__spi_8c.html#ad51e687d5598f38640fb99635774b2bd">User_SPI_Burst_Setup</a> ()</td></tr>
<tr class="memdesc:ad51e687d5598f38640fb99635774b2bd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configures SPI for a burst buffer read.  <a href="user__spi_8c.html#ad51e687d5598f38640fb99635774b2bd">More...</a><br /></td></tr>
<tr class="separator:ad51e687d5598f38640fb99635774b2bd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac75f5056b4e9ecb70b28865e0a893ab4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="user__spi_8c.html#ac75f5056b4e9ecb70b28865e0a893ab4">User_SPI_Burst_Disable</a> ()</td></tr>
<tr class="memdesc:ac75f5056b4e9ecb70b28865e0a893ab4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Restore SPI functionality after a burst read.  <a href="user__spi_8c.html#ac75f5056b4e9ecb70b28865e0a893ab4">More...</a><br /></td></tr>
<tr class="separator:ac75f5056b4e9ecb70b28865e0a893ab4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3381cb39831e32d78aea87ba9c605942"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="user__spi_8c.html#a3381cb39831e32d78aea87ba9c605942">User_SPI_Update_Config</a> (uint32_t CheckUnlock)</td></tr>
<tr class="memdesc:a3381cb39831e32d78aea87ba9c605942"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the slave SPI (SPI2) config based on the USER_SPI_CONFIG register.  <a href="user__spi_8c.html#a3381cb39831e32d78aea87ba9c605942">More...</a><br /></td></tr>
<tr class="separator:a3381cb39831e32d78aea87ba9c605942"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a090b8a30a19d0dbdd3dbcfed8dc2df69"><td class="memItemLeft" align="right" valign="top">volatile uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="user__spi_8c.html#a090b8a30a19d0dbdd3dbcfed8dc2df69">g_userburstRunning</a> = 0u</td></tr>
<tr class="separator:a090b8a30a19d0dbdd3dbcfed8dc2df69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b151b35b66587c98f3bb8242748850c"><td class="memItemLeft" align="right" valign="top">volatile uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="user__spi_8c.html#a0b151b35b66587c98f3bb8242748850c">g_user_burst_start</a> = 0u</td></tr>
<tr class="separator:a0b151b35b66587c98f3bb8242748850c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba8777d4fcc7421b53dec4cff10482f9"><td class="memItemLeft" align="right" valign="top"><a id="aba8777d4fcc7421b53dec4cff10482f9"></a>
static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><b>SPI2_CR1</b></td></tr>
<tr class="separator:aba8777d4fcc7421b53dec4cff10482f9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2bdd8698c86c19c7c77965e4a292b3a8"><td class="memItemLeft" align="right" valign="top"><a id="a2bdd8698c86c19c7c77965e4a292b3a8"></a>
static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><b>SPI2_CR2</b></td></tr>
<tr class="separator:a2bdd8698c86c19c7c77965e4a292b3a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>iSensor-SPI-Buffer user (slave) SPI module </p>
<p>Copyright (c) Analog Devices Inc, 2020 All Rights Reserved.</p>
<dl class="section date"><dt>Date</dt><dd>4/28/2020 </dd></dl>
<dl class="section author"><dt>Author</dt><dd>A. Nolan (<a href="#" onclick="location.href='mai'+'lto:'+'ale'+'x.'+'nol'+'an'+'@an'+'al'+'og.'+'co'+'m'; return false;">alex.<span style="display: none;">.nosp@m.</span>nola<span style="display: none;">.nosp@m.</span>n@ana<span style="display: none;">.nosp@m.</span>log.<span style="display: none;">.nosp@m.</span>com</a>) </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="ac75f5056b4e9ecb70b28865e0a893ab4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac75f5056b4e9ecb70b28865e0a893ab4">&#9670;&nbsp;</a></span>User_SPI_Burst_Disable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void User_SPI_Burst_Disable </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Restore SPI functionality after a burst read. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function disables SPI2 DMA requests via hard reset, and disables SPI2 DMA channel. It then re-configures the SPI for user mode. </p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="user__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_cgraph.png" border="0" usemap="#auser__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_cgraph" alt=""/></div>
<map name="user__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_cgraph" id="auser__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_cgraph">
<area shape="rect" title="Restore SPI functionality after a burst read." alt="" coords="5,5,171,32"/>
<area shape="rect" href="user__spi_8c.html#af894683d9f035fc8224bdc09e5f911aa" title="Reset user SPI port." alt="" coords="219,5,337,32"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="user__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_icgraph.png" border="0" usemap="#auser__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_icgraph" alt=""/></div>
<map name="user__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_icgraph" id="auser__spi_8c_ac75f5056b4e9ecb70b28865e0a893ab4_icgraph">
<area shape="rect" title="Restore SPI functionality after a burst read." alt="" coords="209,5,375,32"/>
<area shape="rect" href="isr_8c.html#a738473a5b43f6c92b80ce1d3d6f77ed9" title="This function handles the user SPI (SPI2) chip select rising edge." alt="" coords="5,5,161,32"/>
</map>
</div>

</div>
</div>
<a id="ad51e687d5598f38640fb99635774b2bd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad51e687d5598f38640fb99635774b2bd">&#9670;&nbsp;</a></span>User_SPI_Burst_Setup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void User_SPI_Burst_Setup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Configures SPI for a burst buffer read. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function must be called when there is buffered data available to be read, which has been copied to the buffer output data registers. </p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="user__spi_8c_ad51e687d5598f38640fb99635774b2bd_cgraph.png" border="0" usemap="#auser__spi_8c_ad51e687d5598f38640fb99635774b2bd_cgraph" alt=""/></div>
<map name="user__spi_8c_ad51e687d5598f38640fb99635774b2bd_cgraph" id="auser__spi_8c_ad51e687d5598f38640fb99635774b2bd_cgraph">
<area shape="rect" title="Configures SPI for a burst buffer read." alt="" coords="5,5,161,32"/>
<area shape="rect" href="user__spi_8c.html#af894683d9f035fc8224bdc09e5f911aa" title="Reset user SPI port." alt="" coords="209,5,328,32"/>
</map>
</div>

</div>
</div>
<a id="af894683d9f035fc8224bdc09e5f911aa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af894683d9f035fc8224bdc09e5f911aa">&#9670;&nbsp;</a></span>User_SPI_Reset()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void User_SPI_Reset </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="main_8h.html#af6a258d8f3ee5206d682d799316314b1">bool</a>&#160;</td>
          <td class="paramname"><em>register_mode</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reset user SPI port. </p>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>Disable and re-enable SPI using RCC. Kind of hacky, not a clean way to do this. This is required because there is no way to clear Tx FIFO in the SPI peripheral otherwise when operating as a SPI slave.</p>
<p>After using the RCC to reset the SPI, it is configured for register mode (8-bit words, Rx interrupt on FIFO half full) or burst mode (16-bit mode, no interrupts). </p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="user__spi_8c_af894683d9f035fc8224bdc09e5f911aa_icgraph.png" border="0" usemap="#auser__spi_8c_af894683d9f035fc8224bdc09e5f911aa_icgraph" alt=""/></div>
<map name="user__spi_8c_af894683d9f035fc8224bdc09e5f911aa_icgraph" id="auser__spi_8c_af894683d9f035fc8224bdc09e5f911aa_icgraph">
<area shape="rect" title="Reset user SPI port." alt="" coords="423,31,541,57"/>
<area shape="rect" href="user__spi_8c.html#ac75f5056b4e9ecb70b28865e0a893ab4" title="Restore SPI functionality after a burst read." alt="" coords="209,5,375,32"/>
<area shape="rect" href="user__spi_8c.html#ad51e687d5598f38640fb99635774b2bd" title="Configures SPI for a burst buffer read." alt="" coords="214,56,370,83"/>
<area shape="rect" href="isr_8c.html#a738473a5b43f6c92b80ce1d3d6f77ed9" title="This function handles the user SPI (SPI2) chip select rising edge." alt="" coords="5,5,161,32"/>
</map>
</div>

</div>
</div>
<a id="a3381cb39831e32d78aea87ba9c605942"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3381cb39831e32d78aea87ba9c605942">&#9670;&nbsp;</a></span>User_SPI_Update_Config()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void User_SPI_Update_Config </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>CheckUnlock</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Updates the slave SPI (SPI2) config based on the USER_SPI_CONFIG register. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">CheckUnlock</td><td>Flag to check if the USER_SPI is unlocked (0xA5 written to config reg upper)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void</dd></dl>
<p>This function performs all needed initialization for the slave SPI port, and should be called as start of the firmware start up process. If CheckUnlock is true, then the function will check that the upper 8 bits of USER_SPI_CONFIG is 0xA5. If it is not, the SPI update will not be processed. This prevents accidental writes to the SPI config register.</p>
<p>IMPORTANT! From the STM32F303 TRM:</p>
<p>When the data frame size fits into one byte (less than or equal to 8 bits), data packing is used automatically when any read or write 16-bit access is performed on the SPIx_DR register.</p>
<p>As such, words must be received byte-wise and transmitted word-wise (16-bit). </p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="user__spi_8c_a3381cb39831e32d78aea87ba9c605942_icgraph.png" border="0" usemap="#auser__spi_8c_a3381cb39831e32d78aea87ba9c605942_icgraph" alt=""/></div>
<map name="user__spi_8c_a3381cb39831e32d78aea87ba9c605942_icgraph" id="auser__spi_8c_a3381cb39831e32d78aea87ba9c605942_icgraph">
<area shape="rect" title="Updates the slave SPI (SPI2) config based on the USER_SPI_CONFIG register." alt="" coords="104,5,272,32"/>
<area shape="rect" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4" title="The application entry point." alt="" coords="5,5,56,32"/>
</map>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a0b151b35b66587c98f3bb8242748850c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0b151b35b66587c98f3bb8242748850c">&#9670;&nbsp;</a></span>g_user_burst_start</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint32_t g_user_burst_start = 0u</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Track if a user burst read has been started </p>

</div>
</div>
<a id="a090b8a30a19d0dbdd3dbcfed8dc2df69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a090b8a30a19d0dbdd3dbcfed8dc2df69">&#9670;&nbsp;</a></span>g_userburstRunning</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint32_t g_userburstRunning = 0u</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Track if a burst read is enabled. Global scope </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
